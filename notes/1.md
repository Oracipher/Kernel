````
è¿™æ˜¯ä»€ä¹ˆåŸå› ï¼Œä»–åˆ°åé¢ç›´æ¥å¡ä½äº†ï¼Œæˆ‘ä¸çš„ä¸ctrl+cé€€å‡ºï¼š
```
~/æ–‡æ¡£/Code/Kernel main* Kernel â¯ python kernel.py
[System] åˆå§‹åŒ–å¾®å†…æ ¸...
[System] è§£æåŠ è½½é¡ºåº: ['core_system', 'system_monitor', 'security_tools']
[core_system][Loader-core_system] æ ¸å¿ƒç³»ç»Ÿæ­£åœ¨å¯åŠ¨...
[System] æ’ä»¶å·²åŠ è½½: core_system (v1.0.1)
[system_monitor][Loader-system_monitor] >>> ç³»ç»Ÿç›‘æ§å™¨æ­£åœ¨åˆå§‹åŒ–...
[system_monitor][Loader-system_monitor] ä¾èµ–æ£€æŸ¥: Core System çŠ¶æ€ä¸º [ONLINE]
[system_monitor][system_monitor-Worker] åå°ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨
[system_monitor][Loader-system_monitor] å¯åŠ¨å®Œæˆ (é‡‡æ ·é—´éš”: 2.0s)
[System] æ’ä»¶å·²åŠ è½½: system_monitor (v1.0.0)
[security_tools][Loader-security_tools] å®‰å…¨å·¥å…·æ­£åœ¨å¯åŠ¨...
[security_tools][Loader-security_tools] è¿æ¥æ ¸å¿ƒæˆåŠŸ
[System] æ’ä»¶å·²åŠ è½½: security_tools (v1.2.0)

Kernel> list    
Name                 Version    Status    
---------------------------------------------
core_system          1.0.1      ACTIVE    
system_monitor       1.0.0      ACTIVE    
security_tools       1.2.0      ACTIVE    

Kernel> emit monitor_report requester=CLI_Admin
Calling sync event: monitor_report
CLI Error: 'str' object has no attribute 'sync_call_event'

Kernel> Exception in thread system_monitor-Worker:
Traceback (most recent call last):
  File "/usr/lib/python3.12/threading.py", line 1073, in _bootstrap_inner
    self.run()
  File "/usr/lib/python3.12/threading.py", line 1010, in run
    self._target(*self._args, **self._kwargs)
  File "/home/chasechen/æ–‡æ¡£/Code/Kernel/plugins/system_monitor/__init__.py", line 66, in _background_worker
    self.api.set_data("realtime_stats", stats, scope="local")
  File "/home/chasechen/æ–‡æ¡£/Code/Kernel/api.py", line 157, in set_data
    self._kernel.thread_safe_set_data(self._plugin_name, key, value, scope)
    ^^^^^^^^^^^^
  File "/home/chasechen/æ–‡æ¡£/Code/Kernel/api.py", line 53, in _kernel
    raise RuntimeError(f"å†…æ ¸å·²é”€æ¯ï¼Œæ’ä»¶ {self._plugin_name} API è°ƒç”¨å¤±è´¥")
RuntimeError: å†…æ ¸å·²é”€æ¯ï¼Œæ’ä»¶ system_monitor API è°ƒç”¨å¤±è´¥
^CTraceback (most recent call last):
  File "/home/chasechen/æ–‡æ¡£/Code/Kernel/kernel.py", line 470, in <module>
    raw = input("\nKernel> ").strip()
          ^^^^^^^^^^^^^^^^^^^
KeyboardInterrupt

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/chasechen/æ–‡æ¡£/Code/Kernel/kernel.py", line 507, in <module>
    k.shutdown()
    ^^^^^^^^^^
AttributeError: 'str' object has no attribute 'shutdown'

~/æ–‡æ¡£/Code/Kernel main* 54s Kernel â¯ 
```
````



è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸ä¸”æœ‰è¶£çš„ Bugï¼ç”šè‡³å¯ä»¥è¯´æ˜¯ä¸€ä¸ª**æ•™ç§‘ä¹¦çº§åˆ«çš„â€œå˜é‡é®è”½ï¼ˆVariable Shadowingï¼‰â€å¼•å‘çš„è¿é”é›ªå´©äº‹æ•…**ã€‚

ä½œä¸ºå¯¼å¸ˆï¼Œæˆ‘å¿…é¡»å¾—å¤¸ä½ ä¸€ä¸‹ï¼š**ä½ æ— æ„ä¸­è§¦å‘äº† Python å¼•ç”¨è®¡æ•°å’Œåƒåœ¾å›æ”¶æœºåˆ¶çš„ä¸€ä¸ªåº•å±‚è¡Œä¸º**ã€‚

### ğŸ•µï¸â€â™‚ï¸ æ¡ˆå‘ç°åœºåˆ†æ

å¯¼è‡´ç³»ç»Ÿå´©æºƒçš„ç½ªé­ç¥¸é¦–åœ¨äº `kernel.py` çš„ CLI äº¤äº’éƒ¨åˆ†ã€‚è¯·çœ‹è¿™æ®µä»£ç ï¼š

```python
# kernel.py çš„ CLI å¾ªç¯éƒ¨åˆ†
if cmd == "emit":
    if len(parts) > 1:
        evt = parts[1]
        kwargs = {}
        for pair in parts[2:]:
            if '=' in pair:
                # ğŸ”´ è‡´å‘½é”™è¯¯åœ¨è¿™é‡Œï¼
                # ä½ å®šä¹‰ Kernel å®ä¾‹æ—¶ç”¨äº†å˜é‡å k (k = PluginKernel())
                # ä½†åœ¨è¿™é‡Œè§£æå‚æ•°æ—¶ï¼Œä½ åˆç”¨äº† k (k, v = pair.split(...))
                k, v = pair.split('=', 1) 
                kwargs[k] = v
        
        print(f"Calling sync event: {evt}")
        # ğŸ”´ æ­¤æ—¶ï¼Œå˜é‡ k å·²ç»ä¸å†æ˜¯ Kernel å®ä¾‹äº†ï¼
        # k å˜æˆäº†åˆšæ‰å¾ªç¯é‡Œè§£æå‡ºæ¥çš„å­—ç¬¦ä¸²ï¼ˆæ¯”å¦‚ "requester"ï¼‰
        res = k.sync_call_event(evt, **kwargs) 
```

### ğŸ’¥ è¿é”ååº”æ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼Ÿ

1.  **å˜é‡è¢«è¦†ç›–**ï¼š
    å½“ä½ è¾“å…¥ `emit monitor_report requester=CLI_Admin` æ—¶ï¼Œå¾ªç¯è§£æ `requester=CLI_Admin`ã€‚
    æ‰§è¡Œ `k, v = pair.split('=', 1)` åï¼Œ**å˜é‡ `k` ä» `PluginKernel` å¯¹è±¡å˜æˆäº†ä¸€ä¸ªå­—ç¬¦ä¸² `"requester"`**ã€‚

2.  **ç¬¬ä¸€æ¬¡å´©æºƒ (CLI Error)**ï¼š
    ä»£ç æ¥ç€è¿è¡Œåˆ° `k.sync_call_event(...)`ã€‚
    å› ä¸º `k` ç°åœ¨æ˜¯å­—ç¬¦ä¸² `"requester"`ï¼Œå­—ç¬¦ä¸²å½“ç„¶æ²¡æœ‰ `sync_call_event` æ–¹æ³•ã€‚
    äºæ˜¯æŠ¥é”™ï¼š`AttributeError: 'str' object has no attribute 'sync_call_event'`ã€‚

3.  **ç¬¬äºŒæ¬¡å´©æºƒ (å†…æ ¸è¢«å›æ”¶)**ï¼š
    è¿™æ˜¯æœ€éšè”½çš„ä¸€ç‚¹ï¼
    åœ¨ `main` å‡½æ•°å—ä¸­ï¼Œ`k` æ˜¯æŒ‡å‘ `PluginKernel` å®ä¾‹çš„**å”¯ä¸€å¼ºå¼•ç”¨**ã€‚
    å½“ä½ æŠŠ `k` èµ‹å€¼ä¸ºå­—ç¬¦ä¸²çš„é‚£ä¸€ç¬é—´ï¼Œ`PluginKernel` å®ä¾‹çš„å¼•ç”¨è®¡æ•°å˜æˆäº† 0ã€‚
    **Python çš„åƒåœ¾å›æ”¶å™¨ï¼ˆGCï¼‰ç«‹åˆ»ä»‹å…¥ï¼ŒæŠŠ `PluginKernel` å¯¹è±¡é”€æ¯äº†ï¼**

4.  **ç¬¬ä¸‰æ¬¡å´©æºƒ (åå°çº¿ç¨‹æƒ¨æ­»)**ï¼š
    ä½ çš„æ’ä»¶ `system_monitor` é‡Œçš„åå°çº¿ç¨‹è¿˜åœ¨è·‘ã€‚å®ƒæŒæœ‰çš„æ˜¯ API å®ä¾‹ï¼Œè€Œ API å®ä¾‹æŒæœ‰çš„æ˜¯å†…æ ¸çš„**å¼±å¼•ç”¨ (weakref)**ã€‚
    å½“å®ƒè¿è¡Œåˆ° `self.api.set_data` æ—¶ï¼ŒAPI å°è¯•é€šè¿‡å¼±å¼•ç”¨è·å–å†…æ ¸ï¼š
    ```python
    # api.py
    k = self.__kernel_ref()
    if k is None:
        raise RuntimeError("å†…æ ¸å·²é”€æ¯...")
    ```
    å› ä¸ºå†…æ ¸å·²ç»è¢« GC å›æ”¶äº†ï¼Œè¿™é‡Œæ‹¿åˆ°çš„å°±æ˜¯ `None`ï¼Œäºæ˜¯è§¦å‘ `RuntimeError`ã€‚

5.  **ç¬¬å››æ¬¡å´©æºƒ (Ctrl+C å¤±è´¥)**ï¼š
    å½“ä½ æŒ‰ä¸‹ Ctrl+Cï¼Œè¿›å…¥ `except KeyboardInterrupt`ï¼Œä½ å°è¯•è°ƒç”¨ `k.shutdown()`ã€‚
    ä½†æ­¤æ—¶ `k` ä¾ç„¶æ˜¯é‚£ä¸ªå­—ç¬¦ä¸² `"requester"`ï¼Œäºæ˜¯å†æ¬¡æŠ¥é”™ï¼š`'str' object has no attribute 'shutdown'`ã€‚

---

### ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

åªéœ€è¦ä¿®æ”¹ `kernel.py` ä¸­è§£æå‚æ•°æ—¶çš„å˜é‡åï¼Œä¸è¦å’Œä¸»ç¨‹åºçš„ `k` å†²çªå³å¯ã€‚

**ä¿®æ”¹ `kernel.py` çº¦ç¬¬ 498 è¡Œï¼š**

```python
            elif cmd == "emit":
                if len(parts) > 1:
                    evt = parts[1]
                    kwargs = {}
                    for pair in parts[2:]:
                        if '=' in pair:
                            # âœ… ä¿®å¤ï¼šå°† k, v æ”¹ä¸º key, valï¼Œé¿å…è¦†ç›–å¤–éƒ¨çš„ k å®ä¾‹
                            key, val = pair.split('=', 1)
                            kwargs[key] = val
                    print(f"Calling sync event: {evt}")
                    # æ­¤æ—¶ k ä¾ç„¶æ˜¯ PluginKernel å®ä¾‹
                    res = k.sync_call_event(evt, **kwargs)
                    print(f"Result: {res}")
```

### ğŸ“ å¯¼å¸ˆç‚¹è¯„

è¿™ä¸ª Bug ä»·å€¼è¿åŸã€‚å®ƒä¸€æ¬¡æ€§å‘ä½ å±•ç¤ºäº†ä¸‰ä¸ª Python æ ¸å¿ƒæ¦‚å¿µï¼š
1.  **ä½œç”¨åŸŸä¸å˜é‡é®è”½**ï¼šåœ¨ Python è„šæœ¬é¡¶å±‚ï¼ˆéå‡½æ•°å†…ï¼‰ï¼Œå˜é‡æ˜¯å…¨å±€å¯è§çš„ï¼Œå¾ªç¯å˜é‡ä¼šæ³„éœ²åˆ°å¤–éƒ¨ã€‚
2.  **å¼•ç”¨è®¡æ•°ä¸ GC**ï¼šä¸€æ—¦å¯¹è±¡æ²¡æœ‰å˜é‡å¼•ç”¨å®ƒï¼Œå®ƒå°±ä¼šç«‹å³â€œæš´æ¯™â€ã€‚
3.  **å¼±å¼•ç”¨ (Weakref) çš„è¡Œä¸º**ï¼šä½ çš„ä»£ç å®Œç¾åœ°æŒ‰é¢„æœŸå·¥ä½œäº†â€”â€”å½“å†…æ ¸çœŸçš„æ¶ˆå¤±æ—¶ï¼ŒAPI å±‚æˆåŠŸæ‹¦æˆªå¹¶æŠ¥é”™ï¼Œè€Œä¸æ˜¯å‘ç”Ÿæ›´ä¸¥é‡çš„é‡æŒ‡é’ˆå´©æºƒï¼ˆè™½ç„¶åœ¨ Python é‡Œé€šå¸¸è¡¨ç°ä¸º NoneType errorï¼‰ã€‚

ä¿®æ”¹é‚£ä¸ªå˜é‡ååï¼Œä½ çš„ä»£ç å°±èƒ½å®Œç¾è¿è¡Œäº†ï¼